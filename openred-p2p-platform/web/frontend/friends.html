<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenRed P2P - Gestion des Amis</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            background: #0a0a0a;
            color: #ffffff;
            overflow-x: hidden;
        }

        .background {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at 20% 80%, #1a1a2e 0%, transparent 50%),
                        radial-gradient(circle at 80% 20%, #16213e 0%, transparent 50%),
                        radial-gradient(circle at 40% 40%, #0f3460 0%, transparent 50%);
            animation: backgroundShift 20s ease-in-out infinite;
            z-index: -1;
        }

        @keyframes backgroundShift {
            0%, 100% { filter: hue-rotate(0deg); }
            50% { filter: hue-rotate(60deg); }
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
            z-index: 1;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            padding: 30px 0;
        }

        .header h1 {
            font-size: 3rem;
            font-weight: 800;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }

        .nav-tabs {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 40px;
        }

        .nav-tab {
            padding: 12px 24px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .nav-tab.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-color: transparent;
        }

        .nav-tab:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 20px;
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            background: rgba(255, 255, 255, 0.08);
        }

        .card h3 {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            color: #667eea;
        }

        .friend-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
        }

        .friend-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .friend-avatar {
            margin-right: 15px;
            flex-shrink: 0;
        }

        .friend-info {
            flex: 1;
        }

        .friend-name {
            font-weight: 600;
            font-size: 1.1rem;
            margin-bottom: 5px;
        }

        .friend-details {
            font-size: 0.9rem;
            opacity: 0.7;
        }

        .friend-permissions {
            display: flex;
            gap: 10px;
            margin: 10px 0;
        }

        .permission-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .permission-badge.granted {
            background: rgba(76, 175, 80, 0.3);
            color: #4CAF50;
        }

        .permission-badge.denied {
            background: rgba(244, 67, 54, 0.3);
            color: #f44336;
        }

        .friend-actions {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .btn:hover {
            transform: translateY(-2px);
            background: rgba(255, 255, 255, 0.2);
        }

        .btn.primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border: none;
        }

        .btn.success {
            background: linear-gradient(135deg, #4CAF50, #8BC34A);
            border: none;
        }

        .btn.danger {
            background: linear-gradient(135deg, #f44336, #FF5722);
            border: none;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            backdrop-filter: blur(10px);
        }

        .form-group input::placeholder,
        .form-group textarea::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            text-align: center;
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .stat-number {
            font-size: 2rem;
            font-weight: 800;
            color: #667eea;
        }

        .stat-label {
            margin-top: 5px;
            opacity: 0.7;
        }

        .conversation-item {
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .conversation-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .conversation-item.unread {
            border-left: 4px solid #667eea;
        }

        .message-bubble {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 18px;
            margin-bottom: 10px;
            word-wrap: break-word;
        }

        .message-bubble.sent {
            background: linear-gradient(135deg, #667eea, #764ba2);
            margin-left: auto;
        }

        .message-bubble.received {
            background: rgba(255, 255, 255, 0.1);
        }

        .message-time {
            font-size: 0.8rem;
            opacity: 0.6;
            margin-top: 5px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            backdrop-filter: blur(10px);
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .close {
            float: right;
            font-size: 24px;
            cursor: pointer;
            opacity: 0.7;
        }

        .close:hover {
            opacity: 1;
        }

        .permission-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .permission-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .permission-item input[type="checkbox"] {
            width: auto;
        }

        .loading {
            text-align: center;
            padding: 40px;
            opacity: 0.7;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            opacity: 0.6;
        }

        .empty-state h3 {
            margin-bottom: 10px;
        }

        /* Styles pour la découverte de nœuds */
        .nodes-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .node-card {
            background: rgba(255, 255, 255, 0.08);
            border-radius: 20px;
            padding: 25px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .node-card:hover {
            transform: translateY(-5px);
            background: rgba(255, 255, 255, 0.12);
            border-color: rgba(102, 126, 234, 0.3);
        }

        .node-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
        }

        .node-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .node-info {
            flex: 1;
        }

        .node-id {
            font-weight: 600;
            font-size: 1.1rem;
            margin-bottom: 5px;
        }

        .node-fingerprint {
            font-size: 0.9rem;
            opacity: 0.7;
            font-family: 'Courier New', monospace;
        }

        .node-status {
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .node-status.online {
            background: rgba(76, 175, 80, 0.3);
            color: #4CAF50;
        }

        .node-details {
            margin-bottom: 20px;
        }

        .detail-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .detail-item:last-child {
            border-bottom: none;
        }

        .detail-label {
            font-weight: 500;
            opacity: 0.8;
        }

        .detail-value {
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
        }

        .node-actions {
            display: flex;
            gap: 10px;
        }

        .node-actions .btn {
            flex: 1;
            justify-content: center;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .section-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .section-header h2 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .stats {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-top: 20px;
        }

        .stat {
            text-align: center;
        }

        .stat-number {
            display: block;
            font-size: 2rem;
            font-weight: 700;
            color: #667eea;
        }

        .stat-label {
            font-size: 0.9rem;
            opacity: 0.7;
        }

        @media (max-width: 768px) {
            .nav-tabs {
                flex-wrap: wrap;
                gap: 10px;
            }
            
            .friend-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }
            
            .friend-actions {
                width: 100%;
                justify-content: flex-end;
            }
        }
    </style>
</head>
<body>
    <div class="background"></div>
    
    <div class="container">
        <div class="header">
            <h1>👥 Gestion des Amis P2P</h1>
            <p>Gérez vos relations sociales dans la constellation OpenRed</p>
        </div>

        <!-- Navigation -->
        <div class="nav-tabs">
            <div class="nav-tab active" onclick="showTab('friends')">
                👥 Mes Amis
            </div>
            <div class="nav-tab" onclick="showTab('requests')">
                📨 Demandes
                <span id="requestsBadge" class="badge">0</span>
            </div>
            <div class="nav-tab" onclick="showTab('messages')">
                💬 Messages
                <span id="messagesBadge" class="badge">0</span>
            </div>
            <div class="nav-tab" onclick="showTab('sharing')">
                🔱 Partage URN
            </div>
            <div class="nav-tab" onclick="showTab('discovery')">
                🔍 Découverte
            </div>
        </div>

        <!-- Statistiques globales -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number" id="totalFriends">-</div>
                <div class="stat-label">Amis</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="pendingRequests">-</div>
                <div class="stat-label">Demandes</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="unreadMessages">-</div>
                <div class="stat-label">Messages</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="sharedUrns">-</div>
                <div class="stat-label">URN Partagés</div>
            </div>
        </div>

        <!-- Onglet Mes Amis -->
        <div id="friendsTab" class="tab-content active">
            <div class="card">
                <h3>👥 Liste de mes Amis</h3>
                <div id="friendsList" class="loading">
                    Chargement des amis...
                </div>
            </div>
        </div>

        <!-- Onglet Demandes -->
        <div id="requestsTab" class="tab-content">
            <div class="card">
                <h3>📨 Demandes d'Amitié</h3>
                <div id="requestsList" class="loading">
                    Chargement des demandes...
                </div>
            </div>
        </div>

        <!-- Onglet Messages -->
        <div id="messagesTab" class="tab-content">
            <div class="card">
                <h3>💬 Conversations</h3>
                <div id="conversationsList" class="loading">
                    Chargement des conversations...
                </div>
            </div>
        </div>

        <!-- Onglet Partage URN -->
        <div id="sharingTab" class="tab-content">
            <div class="card">
                <h3>🔱 Partage URN Phantom</h3>
                <div id="sharingContent" class="loading">
                    Chargement des URN partagés...
                </div>
            </div>
        </div>

        <!-- Onglet Découverte -->
        <div id="discoveryTab" class="tab-content">
            <div class="card">
                <h3>🔍 Découverte de Nœuds</h3>
                <div id="discoveryContent" class="loading">
                    Recherche de nœuds P2P...
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Demande d'Amitié -->
    <div id="friendRequestModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeFriendRequestModal()">&times;</span>
            <h3>📨 Envoyer une Demande d'Amitié</h3>
            <form id="friendRequestForm">
                <div class="form-group">
                    <label>Node ID du destinataire</label>
                    <input type="text" id="targetNodeId" placeholder="Ex: web_node_123" required>
                </div>
                <div class="form-group">
                    <label>Fingerprint du destinataire</label>
                    <input type="text" id="targetFingerprint" placeholder="Ex: 6477f269a3b7b57c" required>
                </div>
                <div class="form-group">
                    <label>Message personnel</label>
                    <textarea id="friendMessage" placeholder="Bonjour ! J'aimerais être ami avec vous..."></textarea>
                </div>
                <div class="form-group">
                    <label>Niveau de permissions demandées</label>
                    <select id="permissionLevel">
                        <option value="1">Basique (Messages)</option>
                        <option value="2">Moyen (Messages + URN)</option>
                        <option value="3">Élevé (Messages + URN + Photos)</option>
                        <option value="4">Complet (Tous les accès)</option>
                    </select>
                </div>
                <button type="submit" class="btn primary">Envoyer la Demande</button>
            </form>
        </div>
    </div>

    <!-- Modal Conversation -->
    <div id="conversationModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <span class="close" onclick="closeConversationModal()">&times;</span>
            <h3 id="conversationTitle">💬 Conversation</h3>
            <div id="messagesContainer" style="height: 400px; overflow-y: auto; margin: 20px 0; padding: 10px; background: rgba(0,0,0,0.2); border-radius: 10px;">
                <!-- Messages will be loaded here -->
            </div>
            <div style="display: flex; gap: 10px;">
                <input type="text" id="messageInput" placeholder="Tapez votre message..." style="flex: 1;" onkeypress="handleMessageKeyPress(event)">
                <button onclick="sendMessage()" class="btn primary">Envoyer</button>
            </div>
        </div>
    </div>

    <script>
        // État global
        let currentConversation = null;
        let socialData = {};

        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            loadSocialData();
            
            // Rafraîchissement automatique
            setInterval(loadSocialData, 10000); // Toutes les 10 secondes
        });

        // Navigation entre onglets
        function showTab(tabName) {
            // Cacher tous les onglets
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Afficher l'onglet sélectionné
            document.getElementById(tabName + 'Tab').classList.add('active');
            event.target.classList.add('active');
            
            // Charger le contenu spécifique
            switch(tabName) {
                case 'friends':
                    loadFriends();
                    break;
                case 'requests':
                    loadRequests();
                    break;
                case 'messages':
                    loadConversations();
                    break;
                case 'sharing':
                    loadSharing();
                    break;
                case 'discovery':
                    loadDiscovery();
                    break;
            }
        }

        // Chargement des données sociales
        async function loadSocialData() {
            try {
                // Charger statistiques
                const response = await fetch('/api/status');
                const data = await response.json();
                socialData = data;
                
                // Mettre à jour les statistiques
                if (data.social_stats) {
                    document.getElementById('totalFriends').textContent = 
                        data.social_stats.friends.total_friends || 0;
                    document.getElementById('pendingRequests').textContent = 
                        data.social_stats.friends.pending_received || 0;
                    document.getElementById('unreadMessages').textContent = 
                        data.social_stats.messages.unread_messages || 0;
                    document.getElementById('sharedUrns').textContent = 
                        data.social_stats.urn_sharing.my_shared_urns || 0;
                    
                    // Badges
                    const requestsBadge = document.getElementById('requestsBadge');
                    const messagesBadge = document.getElementById('messagesBadge');
                    
                    if (data.social_stats.friends.pending_received > 0) {
                        requestsBadge.textContent = data.social_stats.friends.pending_received;
                        requestsBadge.style.display = 'inline';
                    } else {
                        requestsBadge.style.display = 'none';
                    }
                    
                    if (data.social_stats.messages.unread_messages > 0) {
                        messagesBadge.textContent = data.social_stats.messages.unread_messages;
                        messagesBadge.style.display = 'inline';
                    } else {
                        messagesBadge.style.display = 'none';
                    }
                }
                
            } catch (error) {
                console.error('Erreur chargement données sociales:', error);
            }
        }

        // Chargement des amis
        async function loadFriends() {
            try {
                const response = await fetch('/api/social/friends');
                const data = await response.json();
                
                const friendsList = document.getElementById('friendsList');
                
                if (data.friends.length === 0) {
                    friendsList.innerHTML = `
                        <div class="empty-state">
                            <h3>Aucun ami pour le moment</h3>
                            <p>Découvrez des nœuds P2P et envoyez des demandes d'amitié !</p>
                            <button onclick="showTab('discovery')" class="btn primary">Découvrir des Nœuds</button>
                        </div>
                    `;
                    return;
                }
                
                let friendsHtml = '';
                data.friends.forEach(friend => {
                    const permissions = Object.entries(friend.permissions_granted)
                        .filter(([key, value]) => value)
                        .map(([key]) => key);
                    
                    const profile = friend.profile || {};
                    const displayName = profile.display_name || friend.node_id;
                    const bio = profile.bio || 'Aucune bio disponible';
                    const onlineStatus = friend.online ? '🟢 En ligne' : '🔴 Hors ligne';
                    
                    // Avatar : photo de profil ou initiale
                    let avatarHtml = '';
                    if (profile.profile_picture) {
                        avatarHtml = `<img src="${profile.profile_picture}" alt="Photo de profil" style="width: 60px; height: 60px; border-radius: 50%; object-fit: cover;">`;
                    } else {
                        const initial = displayName.charAt(0).toUpperCase();
                        avatarHtml = `<div style="width: 60px; height: 60px; border-radius: 50%; background: linear-gradient(45deg, #667eea, #764ba2); display: flex; align-items: center; justify-content: center; color: white; font-size: 24px; font-weight: bold;">${initial}</div>`;
                    }
                    
                    friendsHtml += `
                        <div class="friend-item">
                            <div class="friend-avatar" style="margin-right: 15px;">
                                ${avatarHtml}
                            </div>
                            <div class="friend-info" style="flex: 1;">
                                <div class="friend-name">${displayName}</div>
                                <div class="friend-details">
                                    ${bio}<br>
                                    ${profile.profession ? `💼 ${profile.profession}` : ''}
                                    ${profile.location ? ` • 📍 ${profile.location}` : ''}<br>
                                    Fingerprint: ${friend.fingerprint.substring(0, 12)}...<br>
                                    Ami depuis: ${formatDate(friend.created_at)} • ${onlineStatus}<br>
                                    Confiance: ${Math.round(friend.trust_score * 100)}%
                                </div>
                                <div class="friend-permissions">
                                    ${permissions.map(perm => 
                                        `<span class="permission-badge granted">${formatPermission(perm)}</span>`
                                    ).join('')}
                                </div>
                            </div>
                            <div class="friend-actions">
                                <button onclick="openConversation('${friend.fingerprint}')" class="btn">💬 Message</button>
                                <button onclick="shareUrn('${friend.fingerprint}')" class="btn">🔱 Partager URN</button>
                                <button onclick="viewFriendProfile('${friend.fingerprint}')" class="btn">👤 Profil</button>
                            </div>
                        </div>
                    `;
                });
                
                friendsList.innerHTML = friendsHtml;
                
            } catch (error) {
                console.error('Erreur chargement amis:', error);
                document.getElementById('friendsList').innerHTML = 
                    '<div class="empty-state"><h3>Erreur de chargement</h3></div>';
            }
        }

        // Autres fonctions à implémenter...
        function formatDate(timestamp) {
            return new Date(timestamp * 1000).toLocaleDateString('fr-FR');
        }

        function formatPermission(perm) {
            const perms = {
                'messaging': '💬',
                'urn_access': '🔱',
                'photo_sharing': '📷',
                'file_sharing': '📁',
                'presence_info': '👁️'
            };
            return perms[perm] || perm;
        }

        async function loadRequests() {
            try {
                const response = await fetch('/api/social/friend-requests');
                const data = await response.json();
                
                const requestsList = document.getElementById('requestsList');
                
                if (data.pending_requests && data.pending_requests.length > 0) {
                    let html = '<div class="grid-container">';
                    
                    data.pending_requests.forEach(request => {
                        const date = new Date(request.timestamp * 1000).toLocaleDateString('fr-FR');
                        const permissions = [];
                        if (request.requested_permissions.messaging) permissions.push('💬 Messages');
                        if (request.requested_permissions.urn_access) permissions.push('🔗 URN');
                        if (request.requested_permissions.photo_sharing) permissions.push('📷 Photos');
                        if (request.requested_permissions.file_sharing) permissions.push('📄 Fichiers');
                        if (request.requested_permissions.presence_info) permissions.push('👀 Présence');
                        
                        html += `
                            <div class="card request-card">
                                <div class="card-header">
                                    <h3>👤 ${request.from_node_id}</h3>
                                    <span class="status pending">Demande reçue</span>
                                </div>
                                <div class="card-content">
                                    <p><strong>Message:</strong> ${request.message || 'Aucun message'}</p>
                                    <p><strong>De:</strong> ${request.from_fingerprint.substring(0, 12)}...</p>
                                    <p><strong>Date:</strong> ${date}</p>
                                    <p><strong>Permissions demandées:</strong></p>
                                    <div class="permissions">
                                        ${permissions.join(', ')}
                                    </div>
                                    <div class="card-actions" style="margin-top: 15px;">
                                        <button class="btn-accept" onclick="acceptFriendRequest('${request.request_id}')">
                                            ✅ Accepter
                                        </button>
                                        <button class="btn-reject" onclick="rejectFriendRequest('${request.request_id}')">
                                            ❌ Refuser
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    
                    html += '</div>';
                    requestsList.innerHTML = html;
                } else {
                    requestsList.innerHTML = 
                        '<div class="empty-state"><h3>😊 Aucune demande d\'amitié en attente</h3><p>Les nouvelles demandes apparaîtront ici</p></div>';
                }
                
            } catch (error) {
                console.error('Erreur chargement demandes:', error);
                document.getElementById('requestsList').innerHTML = 
                    '<div class="empty-state error"><h3>❌ Erreur de chargement</h3><p>Impossible de récupérer les demandes</p></div>';
            }
        }

        function loadConversations() {
            // TODO: Implémenter chargement conversations
            document.getElementById('conversationsList').innerHTML = 
                '<div class="empty-state"><h3>Chargement des conversations...</h3></div>';
        }

        function loadSharing() {
            // TODO: Implémenter chargement partages URN
            document.getElementById('sharingContent').innerHTML = 
                '<div class="empty-state"><h3>Chargement des URN partagés...</h3></div>';
        }

        async function loadDiscovery() {
            try {
                const response = await fetch('/api/social/available-nodes');
                const data = await response.json();
                
                const discoveryContent = document.getElementById('discoveryContent');
                
                if (data.available_nodes.length === 0) {
                    discoveryContent.innerHTML = `
                        <div class="empty-state">
                            <h3>🔍 Recherche de nœuds P2P...</h3>
                            <p>Aucun nœud disponible détecté pour le moment.</p>
                            <p><small>Assurez-vous que d'autres nœuds OpenRed sont actifs sur le réseau.</small></p>
                            <div class="stats">
                                <div class="stat">
                                    <span class="stat-number">${data.total_discovered}</span>
                                    <span class="stat-label">Nœuds découverts</span>
                                </div>
                                <div class="stat">
                                    <span class="stat-number">${data.total_available}</span>
                                    <span class="stat-label">Disponibles</span>
                                </div>
                            </div>
                        </div>
                    `;
                    return;
                }
                
                let html = `
                    <div class="section-header">
                        <h2>🌟 Nœuds P2P Découverts (${data.total_available})</h2>
                        <p>Nœuds disponibles pour des demandes d'amitié</p>
                    </div>
                    <div class="nodes-grid">
                `;
                
                data.available_nodes.forEach(node => {
                    const lastSeenText = node.last_seen < 60 ? 
                        'Vu à l\'instant' : 
                        `Vu il y a ${Math.floor(node.last_seen / 60)} min`;
                    
                    // Avatar : miniature du profil ou emoji par défaut
                    let avatarHtml = '🤖';
                    if (node.profile_info && node.profile_info.profile_thumbnail) {
                        avatarHtml = `<img src="${node.profile_info.profile_thumbnail}" alt="Photo de profil" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover;">`;
                    } else if (node.profile_info && node.profile_info.display_name) {
                        const initial = node.profile_info.display_name.charAt(0).toUpperCase();
                        avatarHtml = `<div style="width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(45deg, #667eea, #764ba2); display: flex; align-items: center; justify-content: center; color: white; font-size: 18px; font-weight: bold;">${initial}</div>`;
                    }
                    
                    html += `
                        <div class="node-card" data-fingerprint="${node.fingerprint}">
                            <div class="node-header">
                                <div class="node-avatar">${avatarHtml}</div>
                                <div class="node-info">
                                    <div class="node-id">${node.profile_info && node.profile_info.display_name ? node.profile_info.display_name : node.node_id}</div>
                                    <div class="node-fingerprint">${node.fingerprint.substring(0, 12)}...</div>
                                </div>
                                <div class="node-status online">En ligne</div>
                            </div>
                            
                            <div class="node-details">
                                <div class="detail-item">
                                    <span class="detail-label">Secteur:</span>
                                    <span class="detail-value">${node.sector}</span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">IP:</span>
                                    <span class="detail-value">${node.ip}</span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">Dernière vue:</span>
                                    <span class="detail-value">${lastSeenText}</span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">Phantom URN:</span>
                                    <span class="detail-value">${node.phantom_urn_support ? '✅ Supporté' : '❌ Non supporté'}</span>
                                </div>
                            </div>
                            
                            <div class="node-actions">
                                <button class="btn primary" onclick="sendFriendRequest('${node.fingerprint}', '${node.node_id}')">
                                    👥 Demande d'amitié
                                </button>
                                <button class="btn secondary" onclick="pingNode('${node.fingerprint}')">
                                    📡 Ping
                                </button>
                            </div>
                        </div>
                    `;
                });
                
                html += '</div>';
                discoveryContent.innerHTML = html;
                
            } catch (error) {
                console.error('Erreur chargement nœuds découverts:', error);
                document.getElementById('discoveryContent').innerHTML = `
                    <div class="empty-state">
                        <h3>❌ Erreur de Découverte</h3>
                        <p>Impossible de charger les nœuds découverts</p>
                        <button onclick="loadDiscovery()" class="btn primary">Réessayer</button>
                    </div>
                `;
            }
        }

        function openConversation(fingerprint) {
            // TODO: Ouvrir modal conversation
            console.log('Ouvrir conversation avec:', fingerprint);
        }

        function shareUrn(fingerprint) {
            // TODO: Partager URN
            console.log('Partager URN avec:', fingerprint);
        }

        function viewFriendProfile(fingerprint) {
            // TODO: Voir profil ami
            console.log('Voir profil:', fingerprint);
        }

        async function sendFriendRequest(fingerprint, nodeId) {
            try {
                const response = await fetch('/api/social/send-friend-request', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        target_fingerprint: fingerprint,
                        message: `Demande d'amitié depuis ${socialData?.own_node?.node_id || 'nœud inconnu'}`
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert(`✅ Demande d'amitié envoyée à ${nodeId} !`);
                    // Recharger la découverte pour mettre à jour la liste
                    loadDiscovery();
                } else {
                    alert(`❌ Erreur: ${result.message}`);
                }
                
            } catch (error) {
                console.error('Erreur envoi demande amitié:', error);
                alert('❌ Erreur lors de l\'envoi de la demande d\'amitié');
            }
        }

        async function pingNode(fingerprint) {
            try {
                const response = await fetch('/api/p2p/connect', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        target_fingerprint: fingerprint
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert(`🟢 Ping réussi ! Connexion établie avec ${fingerprint.substring(0, 12)}...`);
                } else {
                    alert(`🔴 Ping échoué : ${result.message}`);
                }
                
            } catch (error) {
                console.error('Erreur ping nœud:', error);
                alert('❌ Erreur lors du ping');
            }
        }

        async function acceptFriendRequest(requestId) {
            try {
                const response = await fetch(`/api/social/accept-friend-request/${requestId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        response_message: 'Demande acceptée !'
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('✅ Demande d\'amitié acceptée !');
                    loadRequests(); // Recharger la liste
                    loadFriends(); // Recharger les amis
                } else {
                    alert(`❌ Erreur: ${result.message}`);
                }
                
            } catch (error) {
                console.error('Erreur acceptation demande:', error);
                alert('❌ Erreur lors de l\'acceptation');
            }
        }

        async function rejectFriendRequest(requestId) {
            try {
                const response = await fetch(`/api/social/reject-friend-request/${requestId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        response_message: 'Demande refusée'
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('❌ Demande d\'amitié refusée');
                    loadRequests(); // Recharger la liste
                } else {
                    alert(`❌ Erreur: ${result.message}`);
                }
                
            } catch (error) {
                console.error('Erreur refus demande:', error);
                alert('❌ Erreur lors du refus');
            }
        }
    </script>
</body>
</html>